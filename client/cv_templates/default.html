<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Generated CV</title>

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700;900&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>

<script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
tailwind.config = {
  darkMode: "class",
  theme: {
    extend: {
      colors: {
        primary: "#2563eb",
        "background-light": "#f3f4f6",
        "background-dark": "#111827",
        "paper-light": "#ffffff",
        "paper-dark": "#1f2937",
        "text-main-light": "#111827",
        "text-main-dark": "#f9fafb",
        "text-muted-light": "#4b5563",
        "text-muted-dark": "#9ca3af",
      },
      fontFamily: {
        serif: ["Merriweather", "serif"],
      },
      maxWidth: { a4: "210mm" }
    },
  },
};
</script>

<style>
body { margin:0; padding:0; }
.page { box-shadow: none; width:210mm; padding:2rem; margin:1rem auto; background-color:white; }
.skill-badge { display:inline-block; background:#2563eb;color:white;padding:2px 6px;border-radius:4px;margin:2px 2px;font-size:0.85rem; }
.export-btn { position:fixed; bottom:20px; right:20px; background:#0f2b66; color:white; padding:12px 16px; border-radius:9999px; font-weight:bold; display:flex; align-items:center; gap:5px; cursor:pointer; z-index:9999; }

</style>
</head>

<body class="bg-background-light dark:bg-background-dark font-serif">

<!-- CV Page -->
<main id="cv-paper" class="page">

  <!-- HEADER -->
  <header class="text-center mb-6">
    <h1 id="name" class="text-3xl font-bold mb-2"></h1>
    <div id="contacts" class="text-sm text-primary flex flex-wrap justify-center gap-2"></div>
  </header>

  <!-- SUMMARY -->
  <section id="summary-section" class="mb-6">
    <h2 class="text-lg font-bold uppercase border-b border-gray-300 mb-2 text-text-main-light dark:text-text-main-dark tracking-wide">Summary</h2>
    <p id="summary-text" class="text-sm leading-relaxed text-justify"></p>
  </section>

  <!-- SKILLS -->
  <section id="skills-section" class="mb-6">
    <h2 class="text-lg font-bold uppercase border-b border-gray-300 mb-2 tracking-wide">Skills</h2>
    <div id="skills-list" class="flex flex-wrap gap-2"></div>
  </section>

  <!-- EXPERIENCE -->
  <section id="experience-section" class="mb-6">
    <h2 class="text-lg font-bold uppercase border-b border-gray-300 mb-2 tracking-wide">Work Experience</h2>
    <div id="experience-list"></div>
  </section>

  <!-- PROJECTS -->
  <section id="projects-section" class="mb-6">
    <h2 class="text-lg font-bold uppercase border-b border-gray-300 mb-2 tracking-wide">Projects</h2>
    <div id="projects-list"></div>
  </section>

  <!-- EDUCATION -->
  <section id="education-section" class="mb-6">
    <h2 class="text-lg font-bold uppercase border-b border-gray-300 mb-2 tracking-wide">Education</h2>
    <div id="education-list"></div>
  </section>

  <!-- CERTIFICATIONS -->
  <section id="certifications-section" class="mb-6">
    <h2 class="text-lg font-bold uppercase border-b border-gray-300 mb-2 tracking-wide">Certifications</h2>
    <div id="certifications-list"></div>
  </section>

</main>

<!-- Export Button -->
<div class="export-btn" onclick="exportPDF()" style="background:#a3e635; color:white ;cursor:pointer;">
  <span class="material-icons">download</span> Export PDF
</div>


<script>
/* ================= HELPERS ================= */
function hideIfEmpty(id, condition) {
  if (!condition) document.getElementById(id).style.display = "none";
}

/* ================= GET ACTIVE CV ================= */
function getActiveCV(templateId = "template_01") {
  const cvs = JSON.parse(localStorage.getItem("generatedCVs") || "[]");
  if (!cvs.length) return null;
  const filtered = cvs.filter(cv => cv.templateId === templateId);
  return filtered.length ? filtered[filtered.length-1].cvData : cvs[cvs.length-1].cvData;
}

/* ================= PROFILE ================= */
function loadUserProfile() {
  const p = JSON.parse(localStorage.getItem("userProfile") || "{}");
  document.getElementById("name").innerText = p.full_name || "";
  const contacts = [];
  if (p.github_url) contacts.push(`<a href="${p.github_url}" target="_blank">GitHub</a>`);
  if (p.linkedin_url) contacts.push(`<a href="${p.linkedin_url}" target="_blank">LinkedIn</a>`);
  if (p.website) contacts.push(`<a href="${p.website}" target="_blank">Portfolio</a>`);
  if (p.email) contacts.push(`<span>${p.email}</span>`);
  if (p.phone) contacts.push(`<span>${p.phone}</span>`);
  document.getElementById("contacts").innerHTML = contacts.join(" <span>|</span> ");
}

/* ================= CV ================= */
function loadCV() {
  const cv = getActiveCV();
  if (!cv) return;

  // Summary
  document.getElementById("summary-text").innerText = cv.summary || "";
  hideIfEmpty("summary-section", cv.summary);

  // Skills
  if (cv.skills?.length) {
    document.getElementById("skills-list").innerHTML = cv.skills.map(s => `<span class="skill-badge">${s}</span>`).join("");
  } else hideIfEmpty("skills-section", false);

  // Experience
  if (cv.experience?.length) {
    document.getElementById("experience-list").innerHTML = cv.experience.map(e => `
      <div class="mb-3">
        <div class="flex justify-between">
          <div><span class="font-bold text-primary">${e.company}</span> — <i>${e.position}</i></div>
          <div class="text-sm">${e.duration || ""}</div>
        </div>
      </div>
    `).join("");
  } else hideIfEmpty("experience-section", false);

  // Projects
  if (cv.projects?.length) {
    document.getElementById("projects-list").innerHTML = cv.projects.map(p => `
      <div class="mb-3">
        <span class="font-bold">${p.project}</span>
        <ul class="list-disc ml-5 text-sm mt-1">
          <li>${p.description}</li>
          ${p.technologies ? `<li><b>Technologies:</b> ${p.technologies}</li>` : ""}
        </ul>
      </div>
    `).join("");
  } else hideIfEmpty("projects-section", false);

  // Education
  if (cv.education?.length) {
    document.getElementById("education-list").innerHTML = cv.education.map(e => `
      <div class="mb-2">
        <b>${e.degree}</b> — <i>${e.field || ""}</i><br/>
        <span class="text-sm">${e.university || ""}</span>
      </div>
    `).join("");
  } else hideIfEmpty("education-section", false);

  // Certifications
  if (cv.certifications?.length) {
    document.getElementById("certifications-list").innerHTML = cv.certifications.map(c => `
      <div class="mb-1">
        ${c.course} — <i>${c.provider}</i>
      </div>
    `).join("");
  } else hideIfEmpty("certifications-section", false);
}

/* ================= PDF ================= */
function exportPDF() {
  const element = document.getElementById("cv-paper");
  const opt = {
    margin:       0,
    filename:     'CV.pdf',
    image:        { type: 'jpeg', quality: 0.98 },
    html2canvas:  { scale: 2, scrollY: 0, useCORS: true, allowTaint: true },
    jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
  };
  html2pdf().set(opt).from(element).save().then(() => {
    // Redirect after PDF is saved
    window.location.href = "/client/index.html";
  });
}


/* ================= INIT ================= */
document.addEventListener("DOMContentLoaded", () => {
  loadUserProfile();
  loadCV();
});
</script>

</body>
</html>
